<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Procesamiento de Informes</title>
  <link rel="stylesheet" href="./static/style.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function(){
      // Manejo del preloader
      if (!sessionStorage.getItem('preloaderShown')){
        setTimeout(function(){
          $("#preloader").fadeOut(500, function() {
            $("#main-content").fadeIn(500);
          });
          sessionStorage.setItem('preloaderShown', 'true');
        }, 2000);
      } else {
        $("#preloader").hide();
        $("#main-content").show();
      }

      // Manejo del overlay de progreso
      $("form").on("submit", function(){
        $("#progress-overlay").fadeIn(200);
      });

      // Cerrar overlay al completar
      $(window).on('focus', function(){
        $("#progress-overlay").fadeOut(200);
      });

      // Manejo de formularios AJAX
      $("form.ajax-form").on("submit", function(e) {
        e.preventDefault();
        var $form = $(this);
        $("#resultado").html("<p class='processing-message'>Procesando, por favor espere...</p>");
        
        $.ajax({
          type: $form.attr("method"),
          url: $form.attr("action"),
          data: $form.serialize(),
          success: function(response) {
            var mensaje = response.mensaje || "Operación completada.";
            $("#resultado").html("<p class='success-message'>" + mensaje + "</p>");
            $("#progress-overlay").fadeOut(200);
            $('html, body').animate({ scrollTop: $("#resultado").offset().top }, 'slow');
          },
          error: function(xhr) {
            var errorMsg = (xhr.responseJSON && xhr.responseJSON.mensaje) ? xhr.responseJSON.mensaje : "Error desconocido";
            $("#resultado").html("<p class='error-message'>Error: " + errorMsg + "</p>");
            $("#progress-overlay").fadeOut(200);
          }
        });
      });

      // Actualizar campos ocultos y guardar en localStorage (para el menú global y para la sección mensual)
      // En el menú principal (solo municipio se usa)
      $("#municipio").on("change", function(){
        var selectedMunicipio = $(this).val();
        $(".hidden-municipio").val(selectedMunicipio);
        localStorage.setItem('selectedMunicipio', selectedMunicipio);
      });
      
      // Para los selects de categoría dentro de cada sección donde se requiere:
      $(".analysis-category").on("change", function(){
        var selectedCategory = $(this).val();
        $(".hidden-category").val(selectedCategory);
        localStorage.setItem('selectedCategory', selectedCategory);
        updateAnalysisCards(selectedCategory.toLowerCase());
      });
      
      // Actualizar global_tipo (si se usa)
      $("#global_tipo").on("change", function(){
        var selectedTipo = $(this).val();
        $(".global-tipo").val(selectedTipo);
        localStorage.setItem('selectedTipo', selectedTipo);
      });

      // Valores iniciales
      var initialMunicipio = $("#municipio").val();
      $(".hidden-municipio").val(initialMunicipio);
      var initialCategory = $(".analysis-category").first().val();
      $(".hidden-category").val(initialCategory);
      var initialTipo = $("#global_tipo").val();
      $(".global-tipo").val(initialTipo);

      // Recuperar de localStorage
      var savedMunicipio = localStorage.getItem('selectedMunicipio');
      if(savedMunicipio){
        $("#municipio").val(savedMunicipio);
        $(".hidden-municipio").val(savedMunicipio);
      } else {
        localStorage.setItem('selectedMunicipio', initialMunicipio);
      }
      var savedCategory = localStorage.getItem('selectedCategory');
      if(savedCategory){
        $(".analysis-category").val(savedCategory);
        $(".hidden-category").val(savedCategory);
      } else {
        localStorage.setItem('selectedCategory', initialCategory);
      }
      var savedTipo = localStorage.getItem('selectedTipo');
      if(savedTipo){
        $("#global_tipo").val(savedTipo);
        $(".global-tipo").val(savedTipo);
      } else {
        localStorage.setItem('selectedTipo', initialTipo);
      }

      // Sincronización de campos hidden para municipio (aplica tanto al menú como a secciones)
      const storedMunicipio = localStorage.getItem("municipioSelected");
      if (storedMunicipio) {
        $('#municipio').val(storedMunicipio);
      }
      $('.hidden-municipio').val($('#municipio').val());
      $('#municipio').on('change', function() {
        const municipioSeleccionado = $(this).val();
        localStorage.setItem("municipioSelected", municipioSeleccionado);
        $('.hidden-municipio').val(municipioSeleccionado);
      });

      // Función para actualizar los cuadros de análisis en Análisis Mensual
      function updateAnalysisCards(category) {
        $(".analysis-card").hide(); // Oculta todas
        if(category === "residencial"){
          $("#card-residencial").show();
        } else if(category === "industrial"){
          $("#card-industrial").show();
        } else if(category === "comercial"){
          $("#card-comercial").show();
        } else if(category === "oficial"){
          $("#card-oficial").show();
        } else {
          $("#analysis-placeholder").html("<p>Seleccione una categoría para ver el cuadro correspondiente.</p>");
        }
      }
      
      // Al cargar la sección mensual, actualiza el cuadro mostrado
      if($("#monthly-section").length){
        var currentCat = $("#monthly-section .analysis-category").val().toLowerCase();
        updateAnalysisCards(currentCat);
      }
      
      // Scroll si hay hash
      if(window.location.hash){
        var target = $(window.location.hash);
        if(target.length){
          $('html, body').animate({ scrollTop: target.offset().top }, 500);
        }
      }
    });
  </script>
  <style>
    /* Estilos básicos */
    .flashes { list-style: none; padding: 0; }
    .flashes li { margin: 5px 0; }
    #resultado { text-align: left; margin-top: 20px; }
    /* Los cuadros de análisis se ocultan inicialmente */
    .analysis-card { display: none; }

    #header-message {
      position: fixed;
      top: 0;
      left: 0;
      background-color: #ffffcc;
      padding: 10px;
      z-index: 1000;
      font-size: 18px;   /* Letra más grande */
      font-weight: bold; /* Texto en negrita */
      border-bottom: 1px solid #ccc;
    }

    body {
      padding-top: 60px;
    }

    .processing-message {
      color: #1d70b8;
      text-align: center;
      font-size: 1.1em;
      margin: 20px 0;
    }
    
    .success-message {
      color: #28a745;
      text-align: center;
      font-size: 1.1em;
      margin: 20px 0;
    }
    
    .error-message {
      color: #dc3545;
      text-align: center;
      font-size: 1.1em;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div id="header-message">
    Recuerda revisar los Excel en cada paso del proceso para que puedas recordar que datos tienes para trabajar.
  </div>
  <!-- Contenedor Global de Resultados -->
  <div id="results-container"></div>

  <!-- Preloader -->
  <div id="preloader">
    <div class="loader">
      <p>Bienvenidos área comercial</p>
    </div>
  </div>

  <!-- Contenido principal (inicialmente oculto) -->
  <div id="main-content" style="display: none;">
    <div class="page-header">
      <div class="logo-container">
        <img src="./static/img/Imagen1.png" alt="Logo 1">
        <img src="./static/img/Imagen2.png" alt="Logo 2">
      </div>
      <h1>Procesamiento de Informes</h1>
    </div>

    <!-- MENÚ PRINCIPAL -->
    <div class="menu-container">
      <form method="get" action="/select_option" id="main-menu-form">
        <h2>Seleccione una opción</h2>
        <select name="option" id="option" class="select-centro" onchange="this.form.submit()">
          <option value="prepare" selected>Preparar Datos</option>
          <option value="monthly" >Análisis Mensual</option>
          <option value="bimonthly" >Análisis Bimestral</option>
          <option value="quarterly" >Análisis Trimestral</option>
        </select>
      </form>
    </div>

    <!-- Contenedor para resultados AJAX -->
    <div id="resultado" class="results-container"></div>

    <!-- Bloque para flash messages -->
    
      
    

    <!-- Sección para "prepare" -->
    
      <div class="container">
        <div class="main-wrapper">
          <!-- Selección de Municipio -->
          <div class="municipio-section">
            <h2>Selección de Municipio</h2>
            <label for="municipio">Seleccione el municipio:</label>
            <select id="municipio">
              
                <option value="Guacarí">Guacarí</option>
              
                <option value="Jamundí">Jamundí</option>
              
                <option value="El Cerrito">El Cerrito</option>
              
                <option value="Quimbaya">Quimbaya</option>
              
                <option value="Circasia">Circasia</option>
              
                <option value="Puerto Asís">Puerto Asís</option>
              
                <option value="Jericó">Jericó</option>
              
                <option value="Ciudad Bolívar">Ciudad Bolívar</option>
              
                <option value="Pueblorico">Pueblorico</option>
              
                <option value="Tarso">Tarso</option>
              
                <option value="Santa Bárbara">Santa Bárbara</option>
              
            </select>
          </div>
          <!-- Formularios de preparación -->
          <div class="process-section prepare-box">
            <h2>Preparación de datos</h2>
            <div class="button-group">
              <form class="ajax-form" action="/step0" method="post">
                <input type="hidden" name="municipio" class="hidden-municipio" value="">
                <button type="submit">Generar Excel Actualizado con el nuevo mes</button>
              </form>
              <form class="ajax-form" action="/step1" method="post">
                <input type="hidden" name="municipio" class="hidden-municipio" value="">
                <button type="submit">Actualizar Archivo Completo con el nuevo mes</button>
              </form>
              <h2>Transformación de datos</h2>
              <div style="border: 1px solid red; background-color: #ffecec; padding: 10px; margin-bottom: 10px; border-radius: 5px; max-width: 400px;">
                <strong>Aviso importante:</strong> Usar este botón en los municipios: Jericó, Tarso, Pueblorrico, Ciudad Bolivar, Santa Barbara, Circasia y Quimbaya.
              </div>
              <form class="ajax-form" action="/step1_01" method="post">
                <input type="hidden" name="municipio" class="hidden-municipio" value="">
                <button type="submit">Estandarizar el Excel</button>

              </form>
              
              <div id="helpBox" style="border: 1px solid #ccc; padding: 10px; margin-top: 10px; border-radius: 5px; background-color: #f9f9f9;">
                <div id="helpToggle" style="cursor: pointer; display: flex; align-items: center;">
                  <span style="font-size: 1.2em; margin-right: 5px;">❓</span>
                  <strong>Ayuda</strong>
                </div>
                <div id="helpContent" style="margin-top: 10px; display: none;">
                  <p> Esta función se encarga de procesar y estandarizar el archivo Excel. Actualiza la información ya existente y normaliza las clasificaciones de datos de acuerdo con criterios predefinidos. Por ejemplo, en municipios como Circasia y Quimbaya, donde los ciclos bimestrales se identifican mediante números (por ejemplo, 64, 66, 69, etc.), la función reemplaza esos números por etiquetas descriptivas como "BIMESTRALES" o "MENSUALES". Además, en municipios como Jericó, Tarso, entre otros, se reclasifica la columna TIPO_USU basándose en una numeración específica (1: Residencial, 2: Comercial, etc.). Utiliza esta función cuando necesites actualizar o corregir la estructura del Excel. </p>
                  <p>
                    Para utilizarla, simplemente presiona el botón "Estandarizar el Excel" y se aplicarán los cambios.
                  </p>
                </div>
              </div>
              
              <script>
                document.getElementById('helpToggle').addEventListener('click', function(){
                  var content = document.getElementById('helpContent');
                  if(content.style.display === 'none' || content.style.display === ''){
                    content.style.display = 'block';
                  } else {
                    content.style.display = 'none';
                  }
                });
              </script>
              
              <h2>Clasificación de datos</h2>
              <div style="border: 1px solid red; background-color: #ffecec; padding: 10px; margin-bottom: 10px; border-radius: 5px; max-width: 400px;">
                <strong>Aviso importante:</strong> ¡Primero revisa si el municipio no tiene una clasificación propia para reconocer si son Mensuales, Bimestrales o Trimestrales!. Es decir, verifica que la columna S_CICLO esté vacía. Este botón debe usarse únicamente en municipios como Jericó, Ciudad Bolivar, Puerto Asís, etc., donde no existe un método específico para identificar el tipo de CICLO, ya que la información correspondiente no se encuentra disponible desde CONLEC. Asegurese de usar este botón solo bajo esos casos para no alterar información previa.
              </div>
              <form class="ajax-form" action="/step1_1" method="post">
                <input type="hidden" name="municipio" class="hidden-municipio" value="">
                <button type="submit">Clasificar S_CICLO</button>
              </form>


              <a href="https://alumbrados.sharepoint.com/:b:/r/sites/CanalesContactos1.0/Documentos%20compartidos/02.%20Gesti%C3%B3n%20del%20conocimiento/11.%20G.%20Comercial/01.%20Documentos/12.%20Instructivo%20uso%20de%20c%C3%B3digo%20automatizados%20de%20consumo.pdf?csf=1&web=1&e=C4JvfQ" target="_blank"
                style="display: inline-block; background-color: yellow; color: black; padding: 10px 20px; text-decoration: none; border: none; border-radius: 5px; font-size: 16px; font-weight: bold;">
                Instructivo
              </a>



            </div>
          </div>
        </div>
      </div>
      <script>
        $(document).ready(function() {
          const storedMunicipio = localStorage.getItem("municipioSelected");
          if(storedMunicipio){
            $('#municipio').val(storedMunicipio);
          }
          $('.hidden-municipio').val($('#municipio').val());
          $('#municipio').on('change', function(){
            const municipioSeleccionado = $(this).val();
            localStorage.setItem("municipioSelected", municipioSeleccionado);
            $('.hidden-municipio').val(municipioSeleccionado);
          });
        });
      </script>

    <!-- Sección de Análisis Mensual -->
    

  </div>
  
  <!-- Overlay de progreso -->
  <div id="progress-overlay">
    <div id="progress-container">
      <div class="spinner"></div>
      <div class="progress-bar"></div>
      <p>Procesando, por favor espere...</p>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="./static/script.js"></script>
  
  <!-- Footer -->
  <footer class="footer">
      <p>Desarrollado por Alexsandra Ortiz</p>
  </footer>
</body>
</html>