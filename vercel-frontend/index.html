<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Procesamiento de Informes</title>
  <link rel="stylesheet" href="./static/style.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function(){
      // Manejo del preloader
      if (!sessionStorage.getItem('preloaderShown')){
        setTimeout(function(){
          $("#preloader").fadeOut(500, function() {
            $("#main-content").fadeIn(500);
          });
          sessionStorage.setItem('preloaderShown', 'true');
        }, 2000);
      } else {
        $("#preloader").hide();
        $("#main-content").show();
      }

      // Manejo del overlay de progreso
      $("form").on("submit", function(){
        $("#progress-overlay").fadeIn(200);
      });

      // Cerrar overlay al completar
      $(window).on('focus', function(){
        $("#progress-overlay").fadeOut(200);
      });

      // Manejo de formularios AJAX
      $("form.ajax-form").on("submit", function(e) {
        e.preventDefault();
        var $form = $(this);
        $("#resultado").html("<p class='processing-message'>Procesando, por favor espere...</p>");
        
        $.ajax({
          type: $form.attr("method"),
          url: $form.attr("action"),
          data: $form.serialize(),
          success: function(response) {
            var mensaje = response.mensaje || "Operación completada.";
            $("#resultado").html("<p class='success-message'>" + mensaje + "</p>");
            $("#progress-overlay").fadeOut(200);
            $('html, body').animate({ scrollTop: $("#resultado").offset().top }, 'slow');
          },
          error: function(xhr) {
            var errorMsg = (xhr.responseJSON && xhr.responseJSON.mensaje) ? xhr.responseJSON.mensaje : "Error desconocido";
            $("#resultado").html("<p class='error-message'>Error: " + errorMsg + "</p>");
            $("#progress-overlay").fadeOut(200);
          }
        });
      });

      // Actualizar campos ocultos y guardar en localStorage (para el menú global y para la sección mensual)
      // En el menú principal (solo municipio se usa)
      $("#municipio").on("change", function(){
        var selectedMunicipio = $(this).val();
        $(".hidden-municipio").val(selectedMunicipio);
        localStorage.setItem('selectedMunicipio', selectedMunicipio);
      });
      
      // Para los selects de categoría dentro de cada sección donde se requiere:
      $(".analysis-category").on("change", function(){
        var selectedCategory = $(this).val();
        $(".hidden-category").val(selectedCategory);
        localStorage.setItem('selectedCategory', selectedCategory);
        updateAnalysisCards(selectedCategory.toLowerCase());
      });
      
      // Actualizar global_tipo (si se usa)
      $("#global_tipo").on("change", function(){
        var selectedTipo = $(this).val();
        $(".global-tipo").val(selectedTipo);
        localStorage.setItem('selectedTipo', selectedTipo);
      });

      // Valores iniciales
      var initialMunicipio = $("#municipio").val();
      $(".hidden-municipio").val(initialMunicipio);
      var initialCategory = $(".analysis-category").first().val();
      $(".hidden-category").val(initialCategory);
      var initialTipo = $("#global_tipo").val();
      $(".global-tipo").val(initialTipo);

      // Recuperar de localStorage
      var savedMunicipio = localStorage.getItem('selectedMunicipio');
      if(savedMunicipio){
        $("#municipio").val(savedMunicipio);
        $(".hidden-municipio").val(savedMunicipio);
      } else {
        localStorage.setItem('selectedMunicipio', initialMunicipio);
      }
      var savedCategory = localStorage.getItem('selectedCategory');
      if(savedCategory){
        $(".analysis-category").val(savedCategory);
        $(".hidden-category").val(savedCategory);
      } else {
        localStorage.setItem('selectedCategory', initialCategory);
      }
      var savedTipo = localStorage.getItem('selectedTipo');
      if(savedTipo){
        $("#global_tipo").val(savedTipo);
        $(".global-tipo").val(savedTipo);
      } else {
        localStorage.setItem('selectedTipo', initialTipo);
      }

      // Sincronización de campos hidden para municipio (aplica tanto al menú como a secciones)
      const storedMunicipio = localStorage.getItem("municipioSelected");
      if (storedMunicipio) {
        $('#municipio').val(storedMunicipio);
      }
      $('.hidden-municipio').val($('#municipio').val());
      $('#municipio').on('change', function() {
        const municipioSeleccionado = $(this).val();
        localStorage.setItem("municipioSelected", municipioSeleccionado);
        $('.hidden-municipio').val(municipioSeleccionado);
      });

      // Función para actualizar los cuadros de análisis en Análisis Mensual
      function updateAnalysisCards(category) {
        $(".analysis-card").hide(); // Oculta todas
        if(category === "residencial"){
          $("#card-residencial").show();
        } else if(category === "industrial"){
          $("#card-industrial").show();
        } else if(category === "comercial"){
          $("#card-comercial").show();
        } else if(category === "oficial"){
          $("#card-oficial").show();
        } else {
          $("#analysis-placeholder").html("<p>Seleccione una categoría para ver el cuadro correspondiente.</p>");
        }
      }
      
      // Al cargar la sección mensual, actualiza el cuadro mostrado
      if($("#monthly-section").length){
        var currentCat = $("#monthly-section .analysis-category").val().toLowerCase();
        updateAnalysisCards(currentCat);
      }
      
      // Scroll si hay hash
      if(window.location.hash){
        var target = $(window.location.hash);
        if(target.length){
          $('html, body').animate({ scrollTop: target.offset().top }, 500);
        }
      }
    });
  </script>
  <style>
    /* Estilos básicos */
    .flashes { list-style: none; padding: 0; }
    .flashes li { margin: 5px 0; }
    #resultado { text-align: left; margin-top: 20px; }
    /* Los cuadros de análisis se ocultan inicialmente */
    .analysis-card { display: none; }

    #header-message {
      position: fixed;
      top: 0;
      left: 0;
      background-color: #ffffcc;
      padding: 10px;
      z-index: 1000;
      font-size: 18px;   /* Letra más grande */
      font-weight: bold; /* Texto en negrita */
      border-bottom: 1px solid #ccc;
    }

    body {
      padding-top: 60px;
    }

    .processing-message {
      color: #1d70b8;
      text-align: center;
      font-size: 1.1em;
      margin: 20px 0;
    }
    
    .success-message {
      color: #28a745;
      text-align: center;
      font-size: 1.1em;
      margin: 20px 0;
    }
    
    .error-message {
      color: #dc3545;
      text-align: center;
      font-size: 1.1em;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div id="header-message">
    Recuerda revisar los Excel en cada paso del proceso para que puedas recordar que datos tienes para trabajar.
  </div>
  <!-- Contenedor Global de Resultados -->
  <div id="results-container"></div>

  <!-- Preloader -->
  <div id="preloader">
    <div class="loader">
      <p>Bienvenidos área comercial</p>
    </div>
  </div>

  <!-- Contenido principal (inicialmente oculto) -->
  <div id="main-content" style="display: none;">
    <div class="page-header">
      <div class="logo-container">
        <img src="./static/img/Imagen1.png" alt="Logo 1">
        <img src="./static/img/Imagen2.png" alt="Logo 2">
      </div>
      <h1>Procesamiento de Informes</h1>
    </div>

    <!-- MENÚ PRINCIPAL -->
    <div class="menu-container">
      <form method="get" action="/select_option" id="main-menu-form">
        <h2>Seleccione una opción</h2>
        <select name="option" id="option" class="select-centro" onchange="this.form.submit()">
          <option value="prepare" >Preparar Datos</option>
          <option value="monthly" >Análisis Mensual</option>
          <option value="bimonthly" >Análisis Bimestral</option>
          <option value="quarterly" >Análisis Trimestral</option>
        </select>
      </form>
    </div>

    <!-- Contenedor para resultados AJAX -->
    <div id="resultado" class="results-container"></div>

    <!-- Bloque para flash messages -->
    
      
    

    <!-- Sección para "prepare" -->
    
      <p style="font-size: 24px; text-align: center; font-weight: bold; position: relative; left: 120px;">
      Por favor, seleccione una opción del menú para continuar.
      </p>
    

  </div>
  
  <!-- Overlay de progreso -->
  <div id="progress-overlay">
    <div id="progress-container">
      <div class="spinner"></div>
      <div class="progress-bar"></div>
      <p>Procesando, por favor espere...</p>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="./static/script.js"></script>
  
  <!-- Footer -->
  <footer class="footer">
      <p>Desarrollado por Alexsandra Ortiz</p>
  </footer>
</body>
</html>